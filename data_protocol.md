# 学ロボ2024 CAN/Serialプロトコル  

## ペリフェラルID  

11bitのバイナリにより構成されるPeripheral IDを定義する。  

ペリフェラルIDは以下のような構成となっている。

| 名称 | bit | 概要 |
|:--:|:--:|:--:|
| Board type | 10:8 | 基板の種類 |
| Board ID | 7:4 | 基板固有のID（ロータリーDIPなどで指定）|
| Device ID | 3:0 | 基板につながる各デバイスを指定するID |

なお、Board typeは次の様
| 名称 | ID |
|:--:|:--:|
| 電源基板 | 0x1 |
| ロボマス制御 | 0x2 |
| 汎用GPIO | 0x3 |
| コール用予約済み | 0x0 |

### 例  

たとえばロータリーDIPが0x3のロボマス制御基板につながるID4のモータに関する情報をやり取りしたいときはIDを0x234とする。  

なお、接続デバイス確認用として、ID 0x000を定義する。  
このIDを受信したデバイスは自身のIDを返答すること。  

また、Device ID 0 は各基板自体とやり取りするのに用いる。  
たとえばBoard ID 0x1のGPIO基板にソフトウェアリセットを掛けるなどのコマンドを送る際には 0x310を用いて通信を行う。  

### CAN通信の場合  

CAN通信においては基本IDの部分をペリフェラルIDとして使用する。  

### Serial通信の場合  

UARTやUSB CDCなどのシリアル通信においては、はじめに送信される2byte分の下位11bitをペリフェラルIDとする。  

## レジスタID  

各ペリフェラル内にはパラメータを保存するための複数のレジスタが存在する。  
これらの各レジスタにアクセスするためのレジスタIDを定義する。  

### CAN通信の場合  

CAN通信においては拡張ID部分における下位8bitを使用する。  

上位10bitは予約済みとし0埋めする。  

### Serial通信の場合  

UARTやUSB CDCなどのシリアル通信においては、ペリフェラルIDに続いて送信される1byte分をレジスタIDとして使用する。  
なお、右詰めである。  

## W/R 指定bit  

データを読み出したいのか書きこみたいのかを指定するW/R bitを定義する。  
0で書き込み1で読み出しとなる。  

### CAN通信の場合  

リモートフレームを活用する。  

### Serial通信の場合  

はじめに送信されるbyteの最上位bitをW/R bitとする。  

## まとめ  

### CANの場合  

| bit | 名称 | 概要 |
|:--:|:--:|:--:|
|28:26|Board type|基板の種類|
|25:22|Board ID|基板の固有ID|
|21:18|Device ID|基板につながるデバイスを指定|
|17:8|予約済み|0埋め推奨|
|7:0|Register ID||

### Serial通信の場合  

|byte| bit | 名称 | 概要 |
|:--:|:--:|:--:|:--:|
|0|7|W/R||
|0|6:3|予約済み|0埋め推奨|
|0|2:0|Board type|基板の種類|
|1|7:4|Board ID|基板の固有ID|
|1|3:0|Device ID|基板につながるデバイスを指定|
|2|7:0|Register ID||


